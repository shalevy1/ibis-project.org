

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>User Defined Functions &mdash; Ibis v0.14.0+29.gc382cba documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Ibis v0.14.0+29.gc382cba documentation" href="index.html"/>
        <link rel="next" title="Contributing to Ibis" href="contributing.html"/>
        <link rel="prev" title="Ibis for SQL Programmers" href="sql.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Ibis
          

          
            
            <img src="_static/logo-wide.svg" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                v0.14.0+29.gc382cba
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Installation and Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuring Ibis</a></li>
<li class="toctree-l1"><a class="reference internal" href="impala.html">Using Ibis with Impala</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="sql.html">Ibis for SQL Programmers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">User Defined Functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pandas">Pandas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#element-wise-functions">Element-wise Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reduction-functions">Reduction Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#analytic-functions">Analytic Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#details-of-pandas-udfs">Details of Pandas UDFs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#bigquery">BigQuery</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sqlite">SQLite</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to Ibis</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developing and Contributing to Ibis</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending Ibis</a></li>
<li class="toctree-l1"><a class="reference internal" href="backends.html">Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="legal.html">Legal</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Ibis</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>User Defined Functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/udf.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="user-defined-functions">
<span id="udf"></span><h1>User Defined Functions<a class="headerlink" href="#user-defined-functions" title="Permalink to this headline">¶</a></h1>
<p>Ibis provides a mechanism for writing custom scalar and aggregate functions,
with varying levels of support for different backends. UDFs/UDAFs are a complex
topic.</p>
<p>This section of the documentation will discuss some of the backend specific
details of user defined functions.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The UDF API is provisional and subject to change.</p>
</div>
<div class="section" id="pandas">
<span id="udf-pandas"></span><h2>Pandas<a class="headerlink" href="#pandas" title="Permalink to this headline">¶</a></h2>
<p>Ibis supports defining three kinds of user-defined functions for operations on
expressions targeting the pandas backend: <strong>element-wise</strong>, <strong>reduction</strong>, and
<strong>analytic</strong>.</p>
<div class="section" id="element-wise-functions">
<span id="udf-elementwise"></span><h3>Element-wise Functions<a class="headerlink" href="#element-wise-functions" title="Permalink to this headline">¶</a></h3>
<p>An <strong>element-wise</strong> function is a function that takes N rows as input and
produces N rows of output. <code class="docutils literal notranslate"><span class="pre">log</span></code>, <code class="docutils literal notranslate"><span class="pre">exp</span></code>, and <code class="docutils literal notranslate"><span class="pre">floor</span></code> are examples of
element-wise functions.</p>
<p>Here’s how to define an element-wise function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ibis.expr.datatypes</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">ibis.pandas</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf.elementwise</span><span class="p">(</span><span class="n">input_type</span><span class="o">=</span><span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span> <span class="n">output_type</span><span class="o">=.</span><span class="n">dtdouble</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_one</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="section" id="reduction-functions">
<span id="udf-reduction"></span><h3>Reduction Functions<a class="headerlink" href="#reduction-functions" title="Permalink to this headline">¶</a></h3>
<p>A <strong>reduction</strong> is a function that takes N rows as input and produces 1 row
as output. <code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">mean</span></code> and <code class="docutils literal notranslate"><span class="pre">count</span></code> are examples of reductions. In
the context of a <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>, reductions produce 1 row of output <em>per
group</em>.</p>
<p>Here’s how to define a reduction function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ibis.expr.datatypes</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">ibis.pandas</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf.reduction</span><span class="p">(</span><span class="n">input_type</span><span class="o">=</span><span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">double</span><span class="p">],</span> <span class="n">output_type</span><span class="o">=.</span><span class="n">dtdouble</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">double_mean</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">series</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="analytic-functions">
<span id="udf-analytic"></span><h3>Analytic Functions<a class="headerlink" href="#analytic-functions" title="Permalink to this headline">¶</a></h3>
<p>An <strong>analytic</strong> function is like an <strong>element-wise</strong> function in that it
takes N rows as input and produces N rows of output. The key difference is
that analytic functions can be applied <em>per group</em> using window functions.
Z-score is an example of an analytic function.</p>
<p>Here’s how to define an analytic function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ibis.expr.datatypes</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">ibis.pandas</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf.analytic</span><span class="p">(</span><span class="n">input_type</span><span class="o">=</span><span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">double</span><span class="p">],</span> <span class="n">output_type</span><span class="o">=.</span><span class="n">dtdouble</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zscore</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">series</span> <span class="o">-</span> <span class="n">series</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">series</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="details-of-pandas-udfs">
<h3>Details of Pandas UDFs<a class="headerlink" href="#details-of-pandas-udfs" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="#udf-elementwise"><span class="std std-ref">Element-wise functions</span></a> automatically provide support
for applying your UDF to any combination of scalar values and columns.</li>
<li><a class="reference internal" href="#udf-reduction"><span class="std std-ref">Reduction functions</span></a> automatically provide support for
whole column aggregations, grouped aggregations, and application of your
function over a window.</li>
<li><a class="reference internal" href="#udf-analytic"><span class="std std-ref">Analytic functions</span></a> work in both grouped and non-grouped
settings</li>
<li>The objects you receive as input arguments are either <code class="docutils literal notranslate"><span class="pre">pandas.Series</span></code> or
Python/NumPy scalars.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Any keyword arguments must be given a default value or the function <strong>will
not work</strong>.</p>
<p class="last">A common Python convention is to set the default value to <code class="docutils literal notranslate"><span class="pre">None</span></code> and
handle setting it to something not <code class="docutils literal notranslate"><span class="pre">None</span></code> in the body of the function.</p>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">add_one</span></code> from above as an example, the following call will receive a
<code class="docutils literal notranslate"><span class="pre">pandas.Series</span></code> for the <code class="docutils literal notranslate"><span class="pre">x</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ibis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">con</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">connect</span><span class="p">({</span><span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;df&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">add_one</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>And this will receive the <code class="docutils literal notranslate"><span class="pre">int</span></code> 1:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">add_one</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Since the pandas backend passes around <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> you can accept <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code>
in your function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ibis.expr.datatypes</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">ibis.pandas</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf.elementwise</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_two</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># do stuff with kwargs</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">2.0</span>
</pre></div>
</div>
<p>Or you can leave them out as we did in the example above. You can also
optionally accept specific keyword arguments.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ibis.expr.datatypes</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">ibis.pandas</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf.elementwise</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_two_with_none</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="bigquery">
<h2>BigQuery<a class="headerlink" href="#bigquery" title="Permalink to this headline">¶</a></h2>
<div class="admonition note" id="udf-bigquery">
<p class="first admonition-title">Note</p>
<p class="last">BigQuery only supports element-wise UDFs at this time.</p>
</div>
<p>BigQuery supports UDFs through JavaScript. Ibis provides support for this by
turning Python code into JavaScript.</p>
<p>The interface is very similar to the pandas UDF API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ibis.expr.datatypes</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">ibis.bigquery</span> <span class="kn">import</span> <span class="n">udf</span>

<span class="nd">@udf</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">double</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_bigquery_add_one</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>Ibis will parse the source of the function and turn the resulting Python AST
into JavaScript source code (technically, ECMAScript 2015). Most of the Python
language is supported including classes, functions and generators.</p>
<p>If you want to inspect the generated code you can look at the <code class="docutils literal notranslate"><span class="pre">js</span></code> property
of the function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">my_bigquery_add_one</span><span class="o">.</span><span class="n">js</span><span class="p">)</span>
<span class="go">CREATE TEMPORARY FUNCTION my_bigquery_add_one(x FLOAT64)</span>
<span class="go">RETURNS FLOAT64</span>
<span class="go">LANGUAGE js AS &quot;&quot;&quot;</span>
<span class="go">&#39;use strict&#39;;</span>
<span class="go">function my_bigquery_add_one(x) {</span>
<span class="go">    return (x + 1.0);</span>
<span class="go">}</span>
<span class="go">return my_bigquery_add_one(x);</span>
<span class="go">&quot;&quot;&quot;;</span>
</pre></div>
</div>
<p>When you want to use this function you call it like any other Python
function–only on an ibis expression:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ibis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">my_bigquery_add_one</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">bigquery</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">CREATE TEMPORARY FUNCTION my_bigquery_add_one(x FLOAT64)</span>
<span class="go">RETURNS FLOAT64</span>
<span class="go">LANGUAGE js AS &quot;&quot;&quot;</span>
<span class="go">&#39;use strict&#39;;</span>
<span class="go">function my_bigquery_add_one(x) {</span>
<span class="go">    return (x + 1.0);</span>
<span class="go">}</span>
<span class="go">return my_bigquery_add_one(x);</span>
<span class="go">&quot;&quot;&quot;;</span>

<span class="go">SELECT my_bigquery_add_one(`a`) AS `tmp`</span>
<span class="go">FROM t0</span>
</pre></div>
</div>
</div>
<div class="section" id="sqlite">
<h2>SQLite<a class="headerlink" href="#sqlite" title="Permalink to this headline">¶</a></h2>
<p id="udf-sqlite">TODO</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="contributing.html" class="btn btn-neutral float-right" title="Contributing to Ibis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sql.html" class="btn btn-neutral" title="Ibis for SQL Programmers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Ibis Developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'v0.14.0+29.gc382cba',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65303298-2', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>